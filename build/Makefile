COMPILER=shuxc

CAMLC=ocamlc
OCAML=ocamlfind $(CAMLC) -linkpkg -thread -package core -package llvm -package llvm.analysis
OBJS=exceptions.cmo ast.cmo astprint.cmo scanner.cmo parser.cmo semant.cmo codegen.cmo
INCLUDE=-I ../src/include -g
TARGETS=$(COMPILER)
OCAML_FLAGS=$(INCLUDE) $(OBJS)
EXAMPLES=../examples
SYMLINK=ln -s -f

all: clean symlink $(OBJS) $(TARGETS)

hello: $(COMPILER) $(EXAMPLES)/hello_world.shux
	./shuxc $(EXAMPLES)/hello_world.shux

shuxc: 

scanner.ml: scanner.mll exceptions.ml
	ocamllex scanner.mll

parser.ml parser.mli: parser.mly ast.ml
	ocamlyacc parser.mly

automata: parser.mly
	ocamlyacc -v parser.mly

%: %.ml $(OBJS)
	$(OCAML) $(OCAML_FLAGS) -o $@ $<

%.cmo: %.ml
	$(OCAML) $(OCAML_FLAGS) -c $<
%.cmi: %.mli
	$(OCAML) $(OCAML_FLAGS) -c $<

.PHONY: symlink clean test

symlink:
	$(SYMLINK) ../src/frontend/exceptions.ml 	exceptions.ml
	$(SYMLINK) ../src/frontend/ast.mli 				ast.ml
	$(SYMLINK) ../src/backend/codegen.ml 			codegen.ml
	$(SYMLINK) ../src/frontend/parser.mly			parser.mly
	$(SYMLINK) ../src/frontend/scanner.mll   	scanner.mll
	$(SYMLINK) ../src/backend/semant.ml     	semant.ml
	$(SYMLINK) ../src/shuxc.ml 								shuxc.ml
	$(SYMLINK) ../src/frontend/astprint.ml		astprint.ml

clean:
	rm -rf *.* shuxc

#generated by ocamldep *.ml *.mli
exceptions.cmo:
exceptions.cmx:
parser.cmo: ast.cmo parser.cmi
parser.cmx: ast.cmo parser.cmi
scanner.cmo: parser.cmi 
scanner.cmx: parser.cmx 
ast.cmo:
parser.cmi: ast.cmo
semant.cmo:
semant.cmx:
codegen.cmo:
codegen.cmx:
shuxc.cmo:
shuxc.cmx:
astprint.cmo:
